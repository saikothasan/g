<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lottery Dashboard</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- Custom CSS -->
  <style>
    body { font-family: 'Inter', sans-serif; }
    .color-red { background-color: #e63946; }
    .color-green { background-color: #2ecc71; }
    .color-violet { background-color: #8e44ad; }
    .color-red-violet { background: linear-gradient(45deg, #e63946, #8e44ad); }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .hover-scale { transition: transform 0.2s ease, background-color 0.2s ease; }
    .hover-scale:hover { transform: scale(1.01); background-color: #212529 !important; }
    .prediction-card { border-left: 4px solid #0d6efd; background-color: #1e1e1e; }
    .issue-input { max-width: 400px; }
    .card { border: none; border-radius: 12px; overflow: hidden; }
    .card-header { background-color: #1e1e1e; border-bottom: 1px solid #343a40; }
    .btn-primary { border-radius: 8px; }
    .table { border-radius: 8px; overflow: hidden; }
    .table-dark { background-color: #1e1e1e; }
    .tooltip-inner { background-color: #343a40; }
    .form-control { background-color: #2a2a2a; border-color: #495057; color: #f8f9fa; }
    .form-control:focus { background-color: #2a2a2a; border-color: #0d6efd; color: #f8f9fa; }
    .spinner-border-sm { width: 1rem; height: 1rem; }
  </style>
</head>
<body class="bg-dark text-light">
  <div class="container py-4 py-md-5 px-3 px-md-4">
    <!-- Header -->
    <header class="text-center mb-5">
      <h1 class="display-5 fw-bold text-primary mb-2">Lottery Dashboard</h1>
      <p class="text-muted fs-5">Real-time lottery results and predictive analytics</p>
      <p class="text-muted fs-6">Last updated: <span id="last-updated">--</span></p>
    </header>

    <!-- Current Game and Predictions -->
    <div class="row g-4 mb-5">
      <!-- Current Game Info -->
      <div class="col-lg-6">
        <div class="card bg-dark border-light shadow-lg fade-in" aria-labelledby="current-game-title">
          <div class="card-header">
            <h2 id="current-game-title" class="h5 fw-semibold text-primary mb-0">Current Game</h2>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <p class="text-muted mb-1 fs-6">Issue Number</p>
                <p id="current-issue" class="fw-medium fs-5">--</p>
              </div>
              <div class="col-md-6">
                <p class="text-muted mb-1 fs-6">Start Time</p>
                <p id="current-start" class="fw-medium fs-5">--</p>
              </div>
              <div class="col-md-6">
                <p class="text-muted mb-1 fs-6">Time Remaining</p>
                <p id="current-countdown" class="fw-medium fs-5 text-warning">--</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Predictions -->
      <div class="col-lg-6">
        <div class="card bg-dark border-light shadow-lg fade-in" aria-labelledby="predictions-title">
          <div class="card-header">
            <h2 id="predictions-title" class="h5 fw-semibold text-primary mb-0">Number Predictions</h2>
          </div>
          <div class="card-body">
            <!-- Real-time Predictions -->
            <h3 class="h6 fw-medium text-info mb-3">Next Game Predictions</h3>
            <div id="real-time-predictions" class="row g-3 mb-4" aria-live="polite">
              <div class="col-12 text-center"><span class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></span> Loading...</div>
            </div>
            <!-- User Issue Prediction -->
            <h3 class="h6 fw-medium text-info mb-3">Predict by Issue Number</h3>
            <div class="input-group mb-3 issue-input">
              <input type="text" id="issue-input" class="form-control" placeholder="Enter issue number" aria-label="Issue number" data-bs-toggle="tooltip" data-bs-placement="top" title="Enter an issue number to predict the next number">
              <button id="predict-btn" class="btn btn-primary" aria-label="Predict number">Predict</button>
            </div>
            <div id="issue-predictions" class="row g-3" aria-live="polite">
              <!-- Populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- History Table -->
    <div class="card bg-dark border-light shadow-lg mb-5" aria-labelledby="history-title">
      <div class="card-header">
        <h2 id="history-title" class="h5 fw-semibold text-primary mb-0">Game History</h2>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-dark table-hover">
            <thead>
              <tr>
                <th scope="col">Issue Number</th>
                <th scope="col">Number</th>
                <th scope="col">Color</th>
                <th scope="col">Premium</th>
                <th scope="col">Sum</th>
              </tr>
            </thead>
            <tbody id="history-table" aria-live="polite">
              <tr><td colspan="5" class="text-center"><span class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></span> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- History Chart -->
    <div class="card bg-dark border-light shadow-lg" aria-labelledby="chart-title">
      <div class="card-header">
        <h2 id="chart-title" class="h5 fw-semibold text-primary mb-0">Number Distribution</h2>
      </div>
      <div class="card-body">
        <canvas id="number-chart" style="max-height: 300px;"></canvas>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/min/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script>
    // Initialize Bootstrap tooltips
    $(function () {
      $('[data-bs-toggle="tooltip"]').tooltip();
    });

    function fetchLotteryData() {
      return $.when(
        $.ajax({
          url: 'https://p.mob.workers.dev/both',
          method: 'GET',
          dataType: 'json'
        }),
        $.ajax({
          url: 'https://p.mob.workers.dev/current',
          method: 'GET',
          dataType: 'json'
        })
      ).then(function(bothResponse, currentResponse) {
        return { both: bothResponse[0], current: currentResponse[0] };
      }).fail(function(jqXHR, textStatus) {
        console.error('Error fetching data:', textStatus);
        $('#issue-predictions').html('<div class="col-12"><p class="text-danger">Failed to fetch data. Please try again.</p></div>');
        $('#real-time-predictions').html('<div class="col-12"><p class="text-danger">Failed to fetch data. Please try again.</p></div>');
        $('#history-table').html('<tr><td colspan="5" class="text-center"><p class="text-danger">Failed to fetch data. Please try again.</p></td></tr>');
      });
    }

    function formatTimestamp(timestamp) {
      return moment(timestamp).format('MMM D, YYYY HH:mm:ss');
    }

    function updateCurrentGame(current) {
      $('#current-issue').text(current.current.issueNumber);
      $('#current-start').text(formatTimestamp(current.current.startTime));

      const endTime = moment(current.current.endTime);
      const updateCountdown = () => {
        const now = moment();
        const timeLeft = endTime.diff(now);
        if (timeLeft <= 0) {
          $('#current-countdown').text('Ended').addClass('text-danger');
          clearInterval(countdownInterval);
          fetchAndUpdate(); // Refresh when game ends
        } else {
          const seconds = Math.floor(timeLeft / 1000);
          $('#current-countdown').text(`${seconds}s`).removeClass('text-danger');
        }
      };
      updateCountdown();
      const countdownInterval = setInterval(updateCountdown, 1000);
    }

    function predictNumbers(bothData, currentData, targetIssue = null) {
      let numbers = bothData.data.list.map(item => ({
        number: parseInt(item.number),
        color: item.color,
        issue: parseInt(item.issueNumber)
      }));

      // Add current.previous data if available and not predicting for a specific issue
      if (!targetIssue && currentData && currentData.previous) {
        numbers.unshift({
          number: parseInt(currentData.previous.number),
          color: currentData.previous.color,
          issue: parseInt(currentData.previous.issueNumber)
        });
      }

      // Filter history before target issue if specified
      if (targetIssue) {
        numbers = numbers.filter(item => item.issue < parseInt(targetIssue));
        if (numbers.length === 0) {
          return { error: 'No data available before this issue number.' };
        }
      }

      // Take last 20 numbers (or fewer if not enough data)
      numbers = numbers.slice(0, 20);

      // Calculate scores for each number (0-9)
      const scores = Array(10).fill(0);
      const maxIssue = Math.max(...numbers.map(n => n.issue));
      numbers.forEach((item, index) => {
        const recencyWeight = index === 0 && !targetIssue ? 1.5 : 1 - (index / 20); // Higher weight for current.previous
        const colorWeight = item.color.includes('red') ? 1.2 : item.color.includes('green') ? 1.1 : 1.0;
        scores[item.number] += recencyWeight * colorWeight;
      });

      // Normalize scores and calculate confidence
      const totalScore = scores.reduce((sum, score) => sum + score, 0);
      const confidences = scores.map(score => totalScore > 0 ? (score / totalScore * 100).toFixed(1) : 0);

      // Get top 3 predictions
      const predictions = scores
        .map((score, index) => ({ number: index, score, confidence: confidences[index] }))
        .sort((a, b) => b.score - a.score)
        .slice(0, 3);

      return { predictions };
    }

    function updatePredictions(predictions, containerId) {
      const $container = $(`#${containerId}`).empty();
      if (predictions.error) {
        $container.append(`
          <div class="col-12">
            <p class="text-danger">${predictions.error}</p>
          </div>
        `);
        return;
      }
      predictions.predictions.forEach(pred => {
        const card = `
          <div class="col-12 prediction-card p-3 rounded">
            <p class="mb-1 text-muted fs-6">Predicted Number: <span class="fw-bold fs-4 text-primary">${pred.number}</span></p>
            <p class="mb-0 text-muted fs-6">Confidence: <span class="fw-medium">${pred.confidence}%</span></p>
          </div>
        `;
        $container.append(card);
      });
    }

    function updateHistoryTable(history) {
      const $tbody = $('#history-table').empty();
      history.data.list.forEach(item => {
        const row = `
          <tr class="hover-scale">
            <td class="py-3">${item.issueNumber}</td>
            <td class="py-3">${item.number}</td>
            <td class="py-3">
              <div class="w-6 h-6 rounded-circle color-${item.color.replace(',', '-')}" title="${item.color}" aria-label="Color: ${item.color}"></div>
            </td>
            <td class="py-3">${item.premium}</td>
            <td class="py-3">${item.sum}</td>
          </tr>
        `;
        $tbody.append(row);
      });
    }

    function updateChart(history) {
      const numbers = history.data.list.slice(0, 20).map(item => parseInt(item.number));
      const frequency = Array(10).fill(0);
      numbers.forEach(num => frequency[num]++);

      const ctx = document.getElementById('number-chart').getContext('2d');
      if (window.numberChart) window.numberChart.destroy();
      window.numberChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Array.from({ length: 10 }, (_, i) => i),
          datasets: [{
            label: 'Number Frequency',
            data: frequency,
            backgroundColor: '#0d6efd',
            borderColor: '#0a58ca',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Occurrences', color: '#f8f9fa' } },
            x: { title: { display: true, text: 'Number', color: '#f8f9fa' } }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    function fetchAndUpdate() {
      $('#real-time-predictions').html('<div class="col-12 text-center"><span class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></span> Loading...</div>');
      $('#history-table').html('<tr><td colspan="5" class="text-center"><span class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></span> Loading...</td></tr>');
      fetchLotteryData().done(data => {
        if (data) {
          $('#last-updated').text(formatTimestamp(Date.now()));
          updateCurrentGame(data.both.current);
          updateHistoryTable(data.both.history);
          updatePredictions(predictNumbers(data.both.history, data.current), 'real-time-predictions');
          updateChart(data.both.history);
        }
      });
    }

    // Handle user issue prediction
    $('#predict-btn').on('click', function() {
      const issueNumber = $('#issue-input').val().trim();
      if (!/^\d+$/.test(issueNumber)) {
        $('#issue-predictions').html('<div class="col-12"><p class="text-danger">Please enter a valid issue number.</p></div>');
        return;
      }
      $('#issue-predictions').html('<div class="col-12 text-center"><span class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></span> Loading...</div>');
      fetchLotteryData().done(data => {
        if (data) {
          const predictions = predictNumbers(data.both.history, null, issueNumber);
          updatePredictions(predictions, 'issue-predictions');
        }
      });
    });

    // Initial fetch and update
    fetchAndUpdate();
    // Refresh every 30 seconds
    setInterval(fetchAndUpdate, 30000);
  </script>
</body>
</html>
